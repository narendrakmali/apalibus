
/**
 * @fileoverview Firestore Security Rules for the bus booking application.
 *
 * Core Philosophy:
 * This ruleset has been updated to allow open access for data submission,
 * as the application no longer requires user authentication. All users can
 * create booking requests. Admin and operator roles are still protected.
 *
 * Data Structure:
 * - /users/{userId}: No longer primarily used for auth, but may store admin flags.
 * - /busOperators/{busOperatorId}: Stores bus operator information, secured by owner-only access.
 * - /busOperators/{busOperatorId}/buses/{busId}: Stores bus information, secured by operator ownership.
 * - /users/{userId}/bookings/{bookingId}: Legacy, may not be used.
 * - /payments/{paymentId}: Stores payment information.
 * - /bookingRequests/{requestId}: Open write for all, managed by operators/admins.
 * - /msrtcBookings/{bookingId}: Open write for all, managed by admins.
 * - /vehicleSubmissions/{submissionId}: Open write for all, managed by admins.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is from an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * @description Checks if the user has an 'operator' role by seeing if they exist in the busOperators collection.
     */
    function isOperator() {
        return isSignedIn() && exists(/databases/$(database)/documents/busOperators/$(request.auth.uid));
    }
    
     /**
     * @description Checks if the user has an 'admin' role by checking the `isAdmin` flag on their user document.
     */
    function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }


    /**
     * @description User profiles are primarily for admins/operators now.
     */
    match /users/{userId} {
      allow get, list, create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for bus operator profiles.
     */
    match /busOperators/{busOperatorId} {
      allow get: if isOwner(busOperatorId) || isAdmin();
      allow list: if isAdmin();
      allow create: if (isSignedIn() && request.resource.data.id == busOperatorId) || isAdmin();
      allow update: if (isOwner(busOperatorId) && request.resource.data.id == resource.data.id) || isAdmin();
      allow delete: if isOwner(busOperatorId) || isAdmin();

        /**
         * @description Rules for buses owned by a bus operator.
         */
        match /buses/{busId} {
          allow get, list: if true; // Public read access to bus information.
          allow create: if isOwner(busOperatorId) && request.resource.data.operatorId == busOperatorId && request.resource.data.id == busId;
          allow update: if (isOwner(busOperatorId) && resource.data.operatorId == busOperatorId && request.resource.data.operatorId == resource.data.operatorId) || isAdmin();
          allow delete: if (isOwner(busOperatorId) && resource.data.operatorId == busOperatorId) || isAdmin();
        }
    }

    /**
     * @description Legacy user bookings. Limited access.
     */
    match /users/{userId}/bookings/{bookingId} {
      allow read, list, create, update, delete: if isOwner(userId) || isAdmin();
    }

    /**
     * @description Payment rules.
     */
    match /payments/{paymentId} {
        allow get: if isAdmin(); // Only admins can see payments for now
        allow list: if isAdmin();
        allow create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for private booking requests. Now publicly writable.
     */
    match /bookingRequests/{requestId} {
      allow create: if true; // Anyone can create a request.
      // Reading a specific request is allowed if you know its ID (e.g. for status tracking), or are an operator/admin.
      allow get: if true; 
      // Listing is restricted to operators and admins to protect user data.
      allow list: if isOperator() || isAdmin();
      allow update: if isOperator() || isAdmin(); // Only operators/admins can update (e.g. approve)
      allow delete: if isAdmin(); 
    }

    /**
     * @description Rules for MSRTC group booking requests. Now publicly writable.
     */
    match /msrtcBookings/{bookingId} {
      allow create: if true; // Anyone can create an MSRTC request.
      // Reading a specific request is allowed if you know its ID.
      allow get: if true;
      // Listing is restricted to operators and admins.
      allow list: if isOperator() || isAdmin();
      allow update, delete: if isAdmin();
    }
    
    /**
     * @description Rules for pre-booked vehicle submissions.
     */
    match /vehicleSubmissions/{submissionId} {
       allow create: if true; // Anyone can submit their vehicle info.
       allow get, list, update, delete: if isAdmin(); // Only admins can manage submissions.
    }
  }
}

    