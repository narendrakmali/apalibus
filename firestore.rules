
/**
 * @fileoverview Firestore Security Rules for the Traverse application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and a role-based system for admins and super-admins. It uses denormalization to avoid costly `get()` calls, making authorization checks efficient.
 *
 * Data Structure & Roles:
 * - /users/{userId}:  Stores user profile data. Access is restricted to the user themselves.
 * - /bus_operators/{operatorId}: Stores information about bus operators.
 * - /buses/{busId}: Contains details about individual buses.
 * - /bookings/{bookingId}: Stores booking information.
 * - /roles/{userId}: Stores the role for a user ('super-admin', 'admin', 'fleet-operator', 'user').
 *
 * Key Security Decisions:
 * - **Users**: Can read/write their own profile, create bookings for themselves, and view their own bookings.
 * - **Admins/Fleet Operators**: Can do everything a user can, plus manage their own buses and operator profile, and confirm/cancel bookings for their own buses. They have read-only access to all data.
 * - **Super-Admins**: Can do everything an admin can, plus they have read/write access to all data for moderation and administrative purposes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @param {string} userId - The user ID to compare against the authenticated user's UID.
     * @returns {bool} True if the user is signed in and the UID matches, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * @description Gets the role of the current user from the /roles collection.
     * @returns {string | null} The user's role ('super-admin', 'admin', 'user') or null if not defined.
     */
    function getUserRole() {
        return get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role;
    }

    /**
     * @description Checks if the user has 'super-admin' privileges.
     * @returns {bool} True if the user is a super-admin, false otherwise.
     */
    function isSuperAdmin() {
      return isSignedIn() && getUserRole() == 'super-admin';
    }

    /**
     * @description Checks if the user has 'admin' privileges (admin, fleet-operator, or super-admin).
     * @returns {bool} True if the user has admin-level access.
     */
    function isAdmin() {
       return isSignedIn() && (getUserRole() == 'admin' || getUserRole() == 'fleet-operator' || isSuperAdmin());
    }

    /**
     * @description Checks if the user has 'user' privileges (i.e., is signed in but not an admin).
     * @returns {bool} True if the user is a regular user.
     */
    function isUser() {
        return isSignedIn() && (getUserRole() == 'user' || getUserRole() == null);
    }


    /**
     * @description Rules for user profiles.
     * - A user can get or update their own profile.
     * - Admins have read-only access.
     * - Super-admins have full read/write access.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isSuperAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow delete: if isOwner(userId) || isSuperAdmin();
    }

    /**
     * @description Rules for bus operator profiles.
     * - Publicly readable.
     * - Can be created by any signed-in user (during operator signup).
     * - Can only be updated by the owning admin or a super-admin.
     */
    match /bus_operators/{operatorId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if (isAdmin() && isOwner(resource.data.createdBy)) || isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Rules for buses.
     * - Publicly readable.
     * - Can be created by an admin.
     * - Can only be updated by the owning admin or a super-admin.
     */
    match /buses/{busId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if (isAdmin() && isOwner(request.resource.data.operatorId)) || isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Rules for bookings.
     * - Users can create bookings for themselves.
     * - Users can get their own bookings. Admins have read access to all bookings.
     * - Listing is allowed for any signed-in user (app queries enforce correct filtering).
     * - Admins can update bookings for their buses. Super-admins have full update access.
     */
    match /bookings/{bookingId} {
        allow get: if (isUser() && isOwner(resource.data.userId)) || isAdmin();
        allow list: if isSignedIn();
        allow create: if isUser() && isOwner(request.resource.data.userId);
        allow update: if (isAdmin() && isOwner(resource.data.operatorId)) || isSuperAdmin();
        allow delete: if isSuperAdmin();
    }

    /**
     * @description Rules for user roles.
     * @path /roles/{userId}
     * - A user can read their own role.
     * - Only super-admins can list, create, update, or delete roles.
     */
    match /roles/{userId} {
      allow get: if isOwner(userId) || isSuperAdmin();
      allow list, create, update, delete: if isSuperAdmin();
    }
  }
}
